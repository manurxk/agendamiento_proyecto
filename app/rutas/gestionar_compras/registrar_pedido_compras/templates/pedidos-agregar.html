{% extends 'base.html' %}

{% block titulo %}
Formulario Agendamiento de Citas Médicas
{% endblock %}

{% block contenido %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3>Formulario Agendamiento de Cita Médica</h3>
        </div>
        <div class="card-body">
            <div class="row">
                
                <!-- Combo médicos -->
                <div class="col col-md-6">
                  <div class="form-group">
                    <label for="cbo_medico">Médicos:</label>
                    <select id="cbo_medico" class="custom-select">
                      <option selected>Seleccionar Médico</option>
                      {% for item in medicos %}
                        <option value="{{ item['id_medico'] }}">
                          {{ item['nombre_medico'] }} - Cédula: {{ item['ci'] }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                
                <!-- Combo sucursales -->
                <div class="col col-md-6">
                  <div class="form-group">
                    <label for="cbo_sucursal">Sucursales:</label>
                    <select id="cbo_sucursal" class="custom-select">
                      <option value="">Seleccionar Sucursal</option>
                      {% for item in sucursales %}
                        <option value="{{ item['id'] }}">
                          {{ item['descripcion'] }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>

            </div>

            <!-- Fecha de la cita -->
            <div class="form-group row">
              <label for="txt_fecha_de_cita" class="col-md-2 col-form-label">Fecha de Cita:</label>
              <div class="col-md-6">
                  <input type="datetime-local" class="form-control" id="txt_fecha_de_cita" />
              </div>
            </div>

            <!-- Especialidad -->
            <div class="form-group row mt-3">
              <label for="cbo_especialidad" class="col-md-2 col-form-label">Especialidad:</label>
              <div class="col-md-6">
                  <select id="cbo_especialidad" class="custom-select">
                    <option value="">Seleccionar Especialidad</option>
                    {% for item in especialidades %}
                        <option value="{{ item['id_especialidad'] }}">
                          {{ item['nombre'] }}
                        </option>
                    {% endfor %}
                  </select>
              </div>
            </div>

            <hr>

            <div class="row">
                <div class="col col-md-12">
                    <table class="table table-hover" id="tbl_citas">
                        <thead>
                          <tr>
                            <th>id</th>
                            <th>Médico</th>
                            <th>Especialidad</th>
                            <th>Fecha y Hora</th>
                            <th>Acciones</th>
                          </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card-footer">
            <button type="button" class="btn btn-primary" id="btn_agendar_cita">Agendar Cita</button>
            <button type="button" class="btn btn-warning" id="btn_salir_agendamiento">Cancelar</button>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
  // variables y constantes globales
  let citas_agendadas = [];

  // Todo lo que provenga del Backend
  const data_from_server = {
    medicos: {{ medicos|tojson }},
    especialidades: {{ especialidades|tojson }}
  }

  function creaTr(item) {
    return `
      <tr data-id="${item.id}">
        <td>${item.id}</td>
        <td>${item.medico}</td>
        <td>${item.especialidad}</td>
        <td>${item.fecha}</td>
        <td><button type="button" class="eliminar btn btn-warning btn-sm">Eliminar Cita</button></td>
      </tr>
    `;
  }

  // Obtener detalles de las citas agendadas
  function obtieneDetalleCitas() {
    const citas = [];
    $('#tbl_citas tbody tr').each(function(k, v) {
      citas.push({
        id: Number($(v).children().eq(0).text()),
        fecha: $(v).children().eq(3).text(),
      });
    });
    return citas;
  }

  /**
  * Define todos los eventos del formulario de agendamiento
  */
  function addEvents() {
    $('#btn_agendar_cita').on('click', function() {
      // Obtener los valores seleccionados
      const id_medico = Number($('#cbo_medico').val());
      const id_sucursal = Number($('#cbo_sucursal').val());
      const fecha_cita = $('#txt_fecha_de_cita').val();
      const id_especialidad = Number($('#cbo_especialidad').val());

      // Validaciones
      if (!id_medico || !id_sucursal || !fecha_cita || !id_especialidad) {
        Swal.fire("Error", "Debe completar todos los campos para agendar la cita", "error");
        return;
      }

      // Buscar médico, especialidad y sucursal correspondientes en los datos
      const medico_seleccionado = data_from_server.medicos.find(m => m.id_medico === id_medico);
      const especialidad_seleccionada = data_from_server.especialidades.find(e => e.id_especialidad === id_especialidad);

      // Añadir cita a la tabla
      const nueva_cita = {
        id: citas_agendadas.length + 1,
        medico: medico_seleccionado.nombre_medico,
        especialidad: especialidad_seleccionada.nombre,
        fecha: fecha_cita,
      };
      
      citas_agendadas.push(nueva_cita);

      // Crear fila en la tabla
      $('#tbl_citas tbody').append(creaTr(nueva_cita));

      // Limpiar los campos después de agregar
      $('#cbo_medico').val("");
      $('#cbo_sucursal').val("");
      $('#txt_fecha_de_cita').val("");
      $('#cbo_especialidad').val("");
    });

    // Eliminar cita de la tabla
    $('#tbl_citas tbody').on('click', '.eliminar', function(){
      const id_cita = Number($(this).closest('tr').data('id'));
      citas_agendadas = citas_agendadas.filter(cita => cita.id !== id_cita);
      $(this).closest('tr').remove();
    });

    // Registro de cita en el servidor
    $('#btn_registrar_cita').on('click', function() {
      const payload = {
        id_medico: Number($('#cbo_medico').val()),
        id_sucursal: Number($('#cbo_sucursal').val()),
        fecha_cita: $('#txt_fecha_de_cita').val(),
        id_especialidad: Number($('#cbo_especialidad').val()),
        detalles: obtieneDetalleCitas()
      };
      
      // Registrar cita en el backend
      fetch(`/api/v1/agendar-cita`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.success) {
          Swal.fire("Éxito", "Cita agendada correctamente.", "success");
        } else {
          Swal.fire("Error", "Ocurrió un error al agendar la cita.", "error");
        }
      })
      .catch(err => {
        console.error('Error al registrar la cita:', err);
        Swal.fire("Error", "Error al registrar la cita.", "error");
      });
    });

    // Cancelar operación
    $('#btn_salir_agendamiento').on('click', function() {
      location.replace("{{ url_for('agendamiento.index') }}");
    });
  }

  $(function() {
    addEvents();
  });
</script>
{% endblock %}
